<div class="dashboard">
  <header class="dashboard-header">
    <div class="header-content">
      <div class="header-title">
        <h1>Workspace</h1>
        <p>Design visually, prompt the AI, and generate Jasper Reports.</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" (click)="clearPrompt()">New Report</button>
        <button class="btn btn-primary" (click)="downloadPdf()" [disabled]="!rawPdfBlob">Export PDF</button>
      </div>
    </div>
  </header>

  <main class="dashboard-main">

    <section class="templates-section">
      <div class="section-header">
        <h2>
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          Previous Templates & Outputs
        </h2>
        <button class="btn btn-text">View All</button>
      </div>
      
      <div class="templates-grid">
        <div class="template-card" *ngFor="let template of previousTemplates" (click)="loadTemplate(template)">
          <div class="template-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
            </svg>
          </div>
          <div class="template-info">
            <h4>{{ template.name }}</h4>
            <span class="template-date">{{ template.date }}</span>
          </div>
          <div class="template-status" [class]="template.status">
            <span class="status-dot"></span>
            {{ template.status }}
          </div>
          <button class="template-action">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="1"/>
              <circle cx="19" cy="12" r="1"/>
              <circle cx="5" cy="12" r="1"/>
            </svg>
          </button>
        </div>
      </div>
    </section>
    
    <section class="workspace-top">
      
      <div class="panel visual-panel">
        
        <div class="editor-toolbar">
          <div class="toolbar-group">
            <select class="tool-select" (change)="changePageSize($event)">
              <option value="A4-P">A4 Portrait</option>
              <option value="A4-L">A4 Landscape</option>
              <option value="A3-P">A3 Portrait</option>
            </select>
            <div class="zoom-controls">
              <button class="btn-icon-small" (click)="zoomOut()">-</button>
              <span class="zoom-level">{{ reportConfig.zoom }}%</span>
              <button class="btn-icon-small" (click)="zoomIn()">+</button>
            </div>
          </div>
          <div class="toolbar-group">
            <button class="btn-tool" (click)="addColumn()">+ Column</button>
            <button class="btn-tool" (click)="addStaticText()">+ Static Text</button>
            <button class="btn-tool text-tool" (click)="addVariablePair()">+ Dynamic Field Pair</button>
          </div>
        </div>

        <div class="formatting-toolbar" [class.active]="selectedIds.size > 0">
          <span class="formatting-label">Text Format:</span>
          <button class="btn-format" (click)="applyStyle('bold')" title="Bold"><b>B</b></button>
          <button class="btn-format" (click)="applyStyle('italic')" title="Italic"><i>I</i></button>
          <button class="btn-format" (click)="applyStyle('underline')" title="Underline"><u>U</u></button>
          <div class="divider"></div>
          <button class="btn-format" (click)="applyStyle('sizeDown')">A-</button>
          <button class="btn-format" (click)="applyStyle('sizeUp')">A+</button>
          <span class="formatting-hint">(Press Delete to remove element)</span>
        </div>

        <div class="panel-body editor-body" (mousedown)="clearSelection()">
          <div class="canvas-wrapper" [style.width.px]="reportConfig.page.width" [style.height.px]="reportConfig.page.height">
            
            <div #canvasRef class="jasper-canvas" 
                 (mousedown)="onCanvasMouseDown($event)"
                 [style.transform]="'scale(' + reportConfig.zoom / 100 + ')'"
                 [style.width.px]="reportConfig.page.width"
                 [style.height.px]="reportConfig.page.height">
              
              <div class="marquee-box" *ngIf="marquee.active" [ngStyle]="marqueeStyle"></div>

              <div class="report-element" 
                   *ngFor="let el of reportConfig.elements"
                   [class.selected]="selectedIds.has(el.id)"
                   [style.left.px]="el.x" 
                   [style.top.px]="el.y"
                   [style.font-size.px]="el.style.fontSize"
                   [style.font-weight]="el.style.bold ? 'bold' : 'normal'"
                   [style.font-style]="el.style.italic ? 'italic' : 'normal'"
                   [style.text-decoration]="el.style.underline ? 'underline' : 'none'"
                   (mousedown)="startDrag('element', el.id, $event)">
                
                <input type="text" [(ngModel)]="el.text" (ngModelChange)="updateJsonTextarea()"
                       [class.variable-input]="el.type === 'variable'"
                       [placeholder]="el.type === 'variable' ? '[Dynamic Data Preview]' : 'Enter text...'">
              </div>

              <div class="margin-line margin-top" [style.top.px]="reportConfig.margins.top" (mousedown)="startDrag('margin', 'top', $event)"></div>
              <div class="margin-line margin-bottom" [style.bottom.px]="reportConfig.page.height - reportConfig.margins.bottom" (mousedown)="startDrag('margin', 'bottom', $event)"></div>
              <div class="margin-line margin-left" [style.left.px]="reportConfig.margins.left" (mousedown)="startDrag('margin', 'left', $event)"></div>
              <div class="margin-line margin-right" [style.right.px]="reportConfig.page.width - reportConfig.margins.right" (mousedown)="startDrag('margin', 'right', $event)"></div>

              <div class="bands-container" [style.padding-top.px]="reportConfig.margins.top">
                
                <div class="jasper-band" [style.height.px]="reportConfig.bands.title">
                  <span class="band-label">Title</span>
                  <div class="band-resizer" (mousedown)="startDrag('band', 'title', $event)"></div>
                </div>

                <div class="jasper-band" [style.height.px]="reportConfig.bands.pageHeader">
                  <span class="band-label">Page Header</span>
                  <div class="band-resizer" (mousedown)="startDrag('band', 'pageHeader', $event)"></div>
                </div>

                <div class="jasper-band band-columns" [style.height.px]="reportConfig.bands.columnHeader">
                  <span class="band-label">Column Header</span>
                  <div class="col-preview" *ngFor="let col of reportConfig.columns; let i = index" [style.width.%]="col.width">
                    <input type="text" [(ngModel)]="col.name" (ngModelChange)="updateJsonTextarea()">
                    <button class="delete-col" (click)="removeColumn(i)">Ã—</button>
                  </div>
                  <div class="band-resizer" (mousedown)="startDrag('band', 'columnHeader', $event)"></div>
                </div>

                <div class="jasper-band band-detail" [style.height.px]="reportConfig.bands.detail">
                  <span class="band-label">Detail 1</span>
                  <div class="band-resizer" (mousedown)="startDrag('band', 'detail', $event)"></div>
                </div>

                <div class="jasper-band" [style.height.px]="reportConfig.bands.pageFooter">
                  <span class="band-label">Page Footer</span>
                  <div class="band-resizer" (mousedown)="startDrag('band', 'pageFooter', $event)"></div>
                </div>

                <div class="jasper-band" [style.height.px]="reportConfig.bands.summary">
                  <span class="band-label">Summary</span>
                  <div class="band-resizer" (mousedown)="startDrag('band', 'summary', $event)"></div>
                </div>

              </div>
              </div>
          </div>
        </div>
      </div>

      <div class="panel output-panel">
        <div class="panel-header">
          <div class="panel-title">Output Preview</div>
        </div>
        <div class="panel-body" style="padding: 0;">
          <div class="output-display" [class.has-content]="pdfUrl">
            <div *ngIf="!pdfUrl" class="output-placeholder">
              <h3>No Output Yet</h3>
              <p>Adjust layout, write a prompt, and hit Generate below.</p>
            </div>
            <object *ngIf="pdfUrl" [data]="pdfUrl" type="application/pdf" width="100%" height="100%"></object>
          </div>
        </div>
      </div>

    </section>

    <section class="workspace-bottom">
      <div class="panel input-panel">
        <div class="panel-body">
          <div class="error-banner" *ngIf="errorMessage">{{ errorMessage }}</div>

          <div class="input-grid">
            <div class="input-col">
              <label class="option-label">AI Prompt</label>
              <textarea 
                class="prompt-input" 
                [(ngModel)]="promptText" 
                placeholder="E.g., Format the Title in bold Arial 18pt. Make the Column Headers blue with white text. Calculate the sum of the Price column in the Summary band."
              ></textarea>
            </div>

            <div class="input-col">
              <label class="option-label">JSON Schema (Auto-syncs with Editor)</label>
              <textarea 
                class="prompt-input code-input" 
                [(ngModel)]="jsonData"
                (ngModelChange)="onJsonManualEdit()"
              ></textarea>
            </div>
          </div>

        </div>
        <div class="panel-footer">
          <button class="btn btn-generate" (click)="generateReport()" [disabled]="isGenerating">
            <span *ngIf="!isGenerating">Generate AI Report</span>
            <span *ngIf="isGenerating" class="generating">Generating...</span>
          </button>
        </div>
      </div>
    </section>

  </main>
</div>